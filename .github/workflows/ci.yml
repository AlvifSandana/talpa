name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test ./...

      - name: Run vet
        run: go vet ./...

      - name: Run race tests
        run: go test -race ./...

      - name: Run CLI JSON smoke checks
        run: bash scripts/ci/smoke_json.sh

      - name: Run CLI negative smoke checks
        run: bash scripts/ci/smoke_negative.sh

  distro-best-effort:
    needs: test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: fedora
            image: fedora@sha256:f1a3fab47bcb3c3ddf3135d5ee7ba8b7b25f2e809a47440936212a3a50957f3d
          - distro: arch
            image: archlinux@sha256:644b416048d39616bbaca93ce768ba492655c83fba80ceca65a4f59dcabdcac0
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tests in ${{ matrix.distro }} container
        run: |
          docker run --rm \
            -v "$PWD":/workspace \
            -w /workspace \
            "${{ matrix.image }}" \
            bash -lc '
              set -euo pipefail
              if command -v dnf >/dev/null 2>&1; then
                dnf install -y golang python3
              elif command -v pacman >/dev/null 2>&1; then
                pacman -Syu --noconfirm --needed go python
              fi
              go test ./...
            '
