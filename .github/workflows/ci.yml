name: CI

on:
  push:
    branches:
      - main
  pull_request:

env:
  CI_LOG_DIR: .ci-logs

defaults:
  run:
    shell: bash

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Prepare CI log directory
        run: mkdir -p "$CI_LOG_DIR"

      - name: Run tests
        run: set -o pipefail && go test ./... 2>&1 | tee "$CI_LOG_DIR/go-test.log"

      - name: Run vet
        run: set -o pipefail && go vet ./... 2>&1 | tee "$CI_LOG_DIR/go-vet.log"

      - name: Run race tests
        run: set -o pipefail && go test -race ./... 2>&1 | tee "$CI_LOG_DIR/go-test-race.log"

      - name: Run CLI JSON smoke checks
        run: set -o pipefail && bash scripts/ci/smoke_json.sh 2>&1 | tee "$CI_LOG_DIR/smoke-json.log"

      - name: Run CLI negative smoke checks
        run: set -o pipefail && bash scripts/ci/smoke_negative.sh 2>&1 | tee "$CI_LOG_DIR/smoke-negative.log"

      - name: Upload test job logs on failure
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-test
          path: ${{ env.CI_LOG_DIR }}/
          if-no-files-found: ignore
          retention-days: 14

  distro-best-effort:
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: fedora
            image: fedora@sha256:f1a3fab47bcb3c3ddf3135d5ee7ba8b7b25f2e809a47440936212a3a50957f3d
          - distro: arch
            image: archlinux@sha256:644b416048d39616bbaca93ce768ba492655c83fba80ceca65a4f59dcabdcac0
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare distro CI log directory
        run: mkdir -p "$CI_LOG_DIR"

      - name: Run tests in ${{ matrix.distro }} container
        run: |
          set -o pipefail
          timeout --signal=TERM --kill-after=30s 15m docker run --rm \
            -v "$PWD":/workspace \
            -w /workspace \
            "${{ matrix.image }}" \
            bash -lc '
              set -euo pipefail

              retry() {
                local attempts="$1"
                local base_delay="$2"
                shift 2
                local try=1
                until "$@"; do
                  echo "Attempt ${try}/${attempts} failed: $*"
                  if [ "$try" -ge "$attempts" ]; then
                    return 1
                  fi
                  sleep "$((base_delay * try))"
                  try="$((try + 1))"
                done
              }

              if command -v dnf >/dev/null 2>&1; then
                retry 3 5 dnf install -y golang python3
              elif command -v pacman >/dev/null 2>&1; then
                retry 3 5 pacman -Syu --noconfirm --needed go python
              fi
              go test ./...
            ' 2>&1 | tee "$CI_LOG_DIR/distro-${{ matrix.distro }}.log"

      - name: Upload distro job logs on failure
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-distro-${{ matrix.distro }}
          path: ${{ env.CI_LOG_DIR }}/
          if-no-files-found: ignore
          retention-days: 14
